{"version":3,"file":"bundle.min.js","sources":["../src/utils/config.ts","../src/utils/tools.ts","../src/libs/vueError.ts","../src/index.ts","../src/libs/jsError.ts","../src/libs/moniterTiming.ts"],"sourcesContent":["\r\nexport interface ConfigType {\r\n  url: string,\r\n  jsError?: boolean\r\n  resourceError?: boolean,\r\n  promiseError?: boolean,\r\n  httpError?: boolean,\r\n  vueError?: boolean,\r\n  consoleError?: boolean,\r\n  scriptError?: boolean,\r\n  staticError?: boolean,\r\n  monitorTiming?: boolean\r\n}\r\n\r\nexport const defaultConfig: ConfigType = {\r\n  url: '',\r\n  jsError: true,\r\n  resourceError: true,\r\n  promiseError: true,\r\n  httpError: true,\r\n  vueError: false,\r\n  monitorTiming: true\r\n  // consoleError: false,\r\n  // scriptError: false,\r\n  // staticError: false\r\n}\r\n","/**\r\n * 检测 URL 是否合法\r\n * @param {string} url\r\n * @returns {boolean}\r\n */\r\nexport function isValidUrl(url: string) {\r\n  try {\r\n    new URL(url)\r\n    return true\r\n  } catch {\r\n    return false\r\n  }\r\n}\r\n\r\nexport function getLines(stack: string) {\r\n  return stack.split('\\n').slice(1).map(item => item.replace(/^\\s+at\\s+/g, '')).join('^')\r\n}\r\n\r\ntype PathElement = Element | Document | Window\r\n\r\nexport function getSelectors(path: PathElement[]) {\r\n  return path\r\n    .reverse()\r\n    .filter((element): element is Element => {\r\n      return element !== document && element !== window && element instanceof Element\r\n    })\r\n    .map(element => {\r\n      if (element.id) {\r\n        return `${element.tagName.toLowerCase()}#${element.id}`\r\n      } else if (element.className && typeof element.className === 'string') {\r\n        return `${element.tagName.toLowerCase()}.${element.className}`\r\n      } else {\r\n        return element.tagName.toLowerCase()\r\n      }\r\n    })\r\n    .join(' ')\r\n}\r\n\r\nexport function getSelector(pathOrElement: PathElement[] | Element) {\r\n  if (Array.isArray(pathOrElement)) {\r\n    return getSelectors(pathOrElement)\r\n  } else {\r\n    return getSelectors([pathOrElement])\r\n  }\r\n}\r\n\r\n","import { moniter } from '@/index'\r\nimport { getLines } from '@u/tools'\r\n\r\nexport const VueMonitorPlugin = {\r\n  install(app) {\r\n    app.config.errorHandler = (e, vm) => {\r\n      moniter.send({\r\n        kind: 'stability', // 监控指标的大类\r\n        type: 'error', // 小类型，这是一个错误\r\n        errorType: 'vueError', // 资源加载错误\r\n        message: e.message, // 报错信息\r\n        tagName: vm.htmlType ?? '', // 错误定位\r\n        stack: getLines(e.stack),\r\n        className: vm.$el.className,\r\n        id: vm.$el.id\r\n      })\r\n    }\r\n  }\r\n}\r\n","import { defaultConfig, type ConfigType  } from '@u/config'\r\nimport { isValidUrl } from '@u/tools'\r\nimport { observerJsError } from '@l/jsError'\r\nexport { VueMonitorPlugin } from '@l/vueError'\r\nimport { observerTiming } from '@l/moniterTiming'\r\nexport class Moniter {\r\n  config: ConfigType = defaultConfig\r\n  constructor() {\r\n    \r\n  }\r\n  init(config: ConfigType) {\r\n    if (!config) throw new Error('config is required')\r\n    this.config = { ...defaultConfig, ...config }\r\n    this.initMonitor()\r\n  }\r\n  initMonitor() {\r\n    const { url } = this.config\r\n    if (!url) throw new Error('report url is required')\r\n    if (!isValidUrl(url)) throw new Error('report url is invalid')\r\n    if (this.config.jsError) {\r\n      observerJsError(this)\r\n    } else if (this.config.monitorTiming) {\r\n      observerTiming(this)\r\n    }\r\n  }\r\n  send(data) {\r\n    console.log(data)\r\n  }\r\n}\r\n\r\nexport const moniter = new Moniter\r\n","import { Moniter } from '@/index'\r\nimport { getLines, getSelector } from '@u/tools'\r\nexport function observerJsError(instance: Moniter) {\r\n  window.addEventListener('error', e => {\r\n    const target = e.target as HTMLElement & { src?: string; href?: string }\r\n    if (target && (target.src || target.href)) {\r\n      instance.send({\r\n        kind: 'stability', // 监控指标的大类\r\n        type: 'error', // 小类型，这是一个错误\r\n        errorType: 'resourceError', // 资源加载错误\r\n        message: e.message, // 报错信息\r\n        filename: target.src || target.href,\r\n        tagName: target.tagName, // 错误定位\r\n        selector: getSelector(target) // 选择器\r\n      })\r\n    } else {\r\n      let log = {\r\n        kind: 'stability', // 监控指标的大类\r\n        type: 'error', // 小类型，这是一个错误\r\n        errorType: 'jsError', // jsError\r\n        message: e.message, // 报错信息\r\n        filename: e.filename,\r\n        position: `${e.lineno}:${e.colno}`, // 错误定位\r\n        stack: getLines(e.error.stack),\r\n        selector: getSelector(target)\r\n      }\r\n      instance.send(log)\r\n    }\r\n  })\r\n}\r\n","import { Moniter } from '@/index'\r\nexport function observerTiming(instance: Moniter) {\r\n  console.log(performance.getEntriesByType('navigation'));\r\n  \r\n  if (document.readyState === 'complete') {\r\n\r\n  } else {\r\n\r\n  }\r\n}\r\n"],"names":["defaultConfig","url","jsError","resourceError","promiseError","httpError","vueError","monitorTiming","getLines","stack","split","slice","map","item","replace","join","getSelectors","path","reverse","filter","element","document","window","Element","id","tagName","toLowerCase","className","getSelector","pathOrElement","Array","isArray","VueMonitorPlugin","install","app","config","errorHandler","e","vm","moniter","send","kind","type","errorType","message","htmlType","$el","Moniter","init","Error","this","initMonitor","URL","isValidUrl","instance","addEventListener","target","src","href","filename","selector","log","position","lineno","colno","error","console","performance","getEntriesByType","data","constructor"],"mappings":"8OAcO,MAAMA,EAA4B,CACvCC,IAAK,GACLC,SAAS,EACTC,eAAe,EACfC,cAAc,EACdC,WAAW,EACXC,UAAU,EACVC,eAAe,GCPV,SAASC,EAASC,GACvB,OAAOA,EAAMC,MAAM,MAAMC,MAAM,GAAGC,IAAIC,GAAQA,EAAKC,QAAQ,aAAc,KAAKC,KAAK,IACrF,CAIO,SAASC,EAAaC,GAC3B,OAAOA,EACJC,UACAC,OAAQC,GACAA,IAAYC,UAAYD,IAAYE,QAAUF,aAAmBG,SAEzEX,IAAIQ,GACCA,EAAQI,GACH,GAAGJ,EAAQK,QAAQC,iBAAiBN,EAAQI,KAC1CJ,EAAQO,WAA0C,iBAAtBP,EAAQO,UACtC,GAAGP,EAAQK,QAAQC,iBAAiBN,EAAQO,YAE5CP,EAAQK,QAAQC,eAG1BX,KAAK,IACV,CAEO,SAASa,EAAYC,GAC1B,OAAIC,MAAMC,QAAQF,GACTb,EAAaa,GAEbb,EAAa,CAACa,GAEzB,CCzCO,MAAMG,EAAmB,CAC9BC,OAAAA,CAAQC,GACNA,EAAIC,OAAOC,aAAe,CAACC,EAAGC,KAC5BC,EAAQC,KAAK,CACXC,KAAM,YACNC,KAAM,QACNC,UAAW,WACXC,QAASP,EAAEO,QACXnB,QAASa,EAAGO,UAAY,GACxBpC,MAAOD,EAAS6B,EAAE5B,OAClBkB,UAAWW,EAAGQ,IAAInB,UAClBH,GAAIc,EAAGQ,IAAItB,KAGjB,GCZK,MAAMuB,EAKXC,IAAAA,CAAKb,GACH,IAAKA,EAAQ,MAAM,IAAIc,MAAM,sBAC7BC,KAAKf,OAAS,IAAKnC,KAAkBmC,GACrCe,KAAKC,aACP,CACAA,WAAAA,GACE,MAAMlD,IAAEA,GAAQiD,KAAKf,OACrB,IAAKlC,EAAK,MAAM,IAAIgD,MAAM,0BAC1B,IFbG,SAAoBhD,GACzB,IAEE,OADA,IAAImD,IAAInD,IACD,CACT,CAAE,MACA,OAAO,CACT,CACF,CEMSoD,CAAWpD,GAAM,MAAM,IAAIgD,MAAM,yBChBnC,IAAyBK,EDiBxBJ,KAAKf,OAAOjC,SCjBYoD,EDkBVJ,KCjBpB5B,OAAOiC,iBAAiB,QAASlB,IAC/B,MAAMmB,EAASnB,EAAEmB,OACjB,GAAIA,IAAWA,EAAOC,KAAOD,EAAOE,MAClCJ,EAASd,KAAK,CACZC,KAAM,YACNC,KAAM,QACNC,UAAW,gBACXC,QAASP,EAAEO,QACXe,SAAUH,EAAOC,KAAOD,EAAOE,KAC/BjC,QAAS+B,EAAO/B,QAChBmC,SAAUhC,EAAY4B,SAEnB,CACL,IAAIK,EAAM,CACRpB,KAAM,YACNC,KAAM,QACNC,UAAW,UACXC,QAASP,EAAEO,QACXe,SAAUtB,EAAEsB,SACZG,SAAU,GAAGzB,EAAE0B,UAAU1B,EAAE2B,QAC3BvD,MAAOD,EAAS6B,EAAE4B,MAAMxD,OACxBmD,SAAUhC,EAAY4B,IAExBF,EAASd,KAAKqB,EAChB,KDNWX,KAAKf,OAAO5B,eEnBzB2D,QAAQL,IAAIM,YAAYC,iBAAiB,cFsBzC,CACA5B,IAAAA,CAAK6B,GACHH,QAAQL,IAAIQ,EACd,CApBA,WAAAC,GAAcpB,KADdf,OAAqBnC,CAGrB,EAqBK,MAAMuC,EAAU,IAAIQ"}